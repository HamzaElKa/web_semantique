<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entité - Foot Explorer | 4IF-WS</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="./static/style.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="bi bi-globe"></i> Foot Explorer
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">
              <i class="bi bi-search"></i> Recherche
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="graph.html">
              <i class="bi bi-diagram-3"></i> Explorer
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="similarity.html">
              <i class="bi bi-stars"></i> Similarité
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="ask.html">
              <i class="bi bi-chat-dots"></i> Chat IA
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Entity Header -->
  <div id="entityHeader" class="entity-header">
    <div class="container">
      <div class="spinner-container">
        <div class="spinner-border text-light" role="status">
          <span class="visually-hidden">Chargement...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-container">
    <div class="container">
      <div class="row">
        <!-- Facts Column -->
        <div class="col-lg-7">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-list-ul"></i> Propriétés (Facts)
            </div>
            <div class="card-body">
              <div id="factsContent">
                <div class="spinner-container">
                  <div class="spinner-border text-primary" role="status"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Neighbors Column -->
        <div class="col-lg-5">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-diagram-2"></i> Voisins (Relations)
              <span id="neighborCount" class="badge bg-light text-dark float-end">0</span>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
              <div id="neighborsContent">
                <div class="spinner-container">
                  <div class="spinner-border text-primary" role="status"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="card mt-3">
            <div class="card-header">
              <i class="bi bi-lightning"></i> Actions rapides
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <button id="viewGraphBtn" class="btn btn-success" disabled>
                  <i class="bi bi-diagram-3"></i> Voir le graphe
                </button>
                <button id="findSimilarBtn" class="btn btn-info" disabled>
                  <i class="bi bi-stars"></i> Trouver similaires
                </button>
                <a href="index.html" class="btn btn-outline-secondary">
                  <i class="bi bi-arrow-left"></i> Nouvelle recherche
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-light py-4 mt-5">
    <div class="container text-center text-muted">
      <p class="mb-0">
        <strong>4IF-WS</strong> - Projet Web Sémantique - INSA Lyon
      </p>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- App JS -->
  <script src="./static/app.js"></script>
  
  <!-- Page Script -->
  <script>
    const { api, UI, URLUtils, checkApiHealth } = window.FootExplorer;

    let currentEntity = null;

    // DOM Elements
    const entityHeader = document.getElementById('entityHeader');
    const factsContent = document.getElementById('factsContent');
    const neighborsContent = document.getElementById('neighborsContent');
    const neighborCount = document.getElementById('neighborCount');
    const viewGraphBtn = document.getElementById('viewGraphBtn');
    const findSimilarBtn = document.getElementById('findSimilarBtn');

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await checkApiHealth();
      
      const uri = URLUtils.getParam('uri');
      if (!uri) {
        entityHeader.innerHTML = `
          <div class="container">
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle"></i>
              Aucune entité spécifiée. <a href="index.html" class="alert-link">Retour à la recherche</a>
            </div>
          </div>
        `;
        return;
      }

      loadEntity(uri);
    });

    async function loadEntity(uri) {
      const endpoint = URLUtils.getParam('endpoint', 'dbpedia');

      try {
        const data = await api.getEntity(uri, endpoint);
        currentEntity = data;
        displayEntity(data);
      } catch (error) {
        entityHeader.innerHTML = `
          <div class="container">
            <div class="alert alert-danger">
              <strong>Erreur de chargement</strong><br>
              ${UI.escapeHtml(error.message)}
            </div>
          </div>
        `;
      }
    }

    function displayEntity(data) {
      // Header
      const label = data.label || UI.extractLabel(data.uri);
      entityHeader.innerHTML = `
        <div class="container">
          <h1 class="entity-title">
            <i class="bi bi-star-fill"></i> ${UI.escapeHtml(label)}
          </h1>
          <div class="entity-uri">
            <i class="bi bi-link-45deg"></i>
            <a href="${UI.escapeHtml(data.uri)}" target="_blank" class="text-white">
              ${UI.escapeHtml(data.uri)}
            </a>
          </div>
          <div class="mt-3">
            <span class="badge bg-light text-dark">
              <i class="bi bi-database"></i> ${data.meta.endpoint}
            </span>
            <span class="badge bg-light text-dark ms-2">
              <i class="bi bi-list"></i> ${Object.keys(data.facts).length} propriétés
            </span>
          </div>
        </div>
      `;

      // Facts
      displayFacts(data.facts);

      // Neighbors
      displayNeighbors(data.neighbors);

      // Enable actions
      viewGraphBtn.disabled = false;
      viewGraphBtn.onclick = () => {
        window.location.href = URLUtils.buildGraphUrl(data.uri);
      };

      findSimilarBtn.disabled = false;
      findSimilarBtn.onclick = () => {
        window.location.href = URLUtils.buildSimilarityUrl(data.uri);
      };
    }

    function displayFacts(facts) {
      if (!facts || Object.keys(facts).length === 0) {
        factsContent.innerHTML = `
          <div class="empty-state">
            <p class="text-muted">Aucune propriété disponible</p>
          </div>
        `;
        return;
      }

      // Sort facts by importance (rdfs:label first, then alphabetically)
      const sortedKeys = Object.keys(facts).sort((a, b) => {
        if (a.toLowerCase().includes('label')) return -1;
        if (b.toLowerCase().includes('label')) return 1;
        return a.localeCompare(b);
      });

      factsContent.innerHTML = sortedKeys.map(predicate => {
        const values = facts[predicate];
        if (!values || values.length === 0) return '';

        return `
          <div class="fact-group">
            <div class="fact-label">
              <i class="bi bi-caret-right-fill"></i> ${UI.escapeHtml(predicate)}
            </div>
            <ul class="fact-values">
              ${values.slice(0, 10).map(item => {
                const value = item.value || item;
                const label = item.label || value;
                
                // Check if value is URI
                if (typeof value === 'string' && value.startsWith('http')) {
                  return `
                    <li>
                      <a href="${URLUtils.buildEntityUrl(value)}">
                        ${UI.escapeHtml(label)}
                      </a>
                      <i class="bi bi-box-arrow-up-right text-muted ms-1" style="font-size: 0.8rem;"></i>
                    </li>
                  `;
                }
                
                return `<li>${UI.escapeHtml(String(label))}</li>`;
              }).join('')}
              ${values.length > 10 ? `<li class="text-muted"><em>... et ${values.length - 10} de plus</em></li>` : ''}
            </ul>
          </div>
        `;
      }).join('');
    }

    function displayNeighbors(neighbors) {
      if (!neighbors || neighbors.length === 0) {
        neighborsContent.innerHTML = `
          <div class="empty-state">
            <p class="text-muted">Aucun voisin trouvé</p>
          </div>
        `;
        return;
      }

      neighborCount.textContent = neighbors.length;

      // Limit to first 100 neighbors
      const displayed = neighbors.slice(0, 100);

      neighborsContent.innerHTML = displayed.map(neighbor => {
        const label = neighbor.label || UI.extractLabel(neighbor.uri);
        return `
          <div class="neighbor-item">
            <div>
              <div class="neighbor-predicate">${UI.escapeHtml(neighbor.predicate)}</div>
              <div class="neighbor-label">
                <a href="${URLUtils.buildEntityUrl(neighbor.uri)}">
                  ${UI.escapeHtml(label)}
                </a>
              </div>
            </div>
            <div>
              <a href="${URLUtils.buildGraphUrl(neighbor.uri)}" 
                 class="btn btn-sm btn-outline-success"
                 title="Voir le graphe">
                <i class="bi bi-diagram-3"></i>
              </a>
            </div>
          </div>
        `;
      }).join('');

      if (neighbors.length > 100) {
        neighborsContent.innerHTML += `
          <div class="alert alert-info mt-3">
            <i class="bi bi-info-circle"></i>
            Affichage limité à 100 voisins (${neighbors.length} au total)
          </div>
        `;
      }
    }
  </script>
</body>
</html>
